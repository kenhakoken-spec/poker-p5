# 計画: 記録画面UX・ロジック修正（日本語）

## PMO 役割とコンテキスト維持

- **PMO（メインエージェント）**: タスク分解・指示書作成・完了条件の明示・参照ファイルの指定のみ。**実装は書かない。**
- **サブエージェント**: 指示書に従い実装 → 単体/E2E 実行 → **MCP ブラウザで画面確認**まで実施。完了報告は「やったこと・変更ファイル・残課題」を短く返す。
- **コンテキスト維持**: 本ドキュメントと `docs/PMO_SUBAGENT.md` を共通前提とする。サブエージェントは割り当てタスク以外の変更を最小化し、完了報告で変更ファイル一覧を明示する。PMO はサブエージェント報告を集約し、次のタスクに「前提となる変更」を指示書に含める。

---

## 全体概要

- ポジション/ハンド画面の英語化・1行表示・「必須」削除・スクロール説明削除
- カードリール: スートを左固定・カードはランクのみ・4スート色分け・縦スクロールなし
- Who is Open: ポジション選択後にアクションを下からせり上げ（半透明オーバーレイ）
- 対向者（**プリフロップのみ**）: Call / Raise 2x / 3x / All-in を表示し、常に「次に動いたポジション」をユーザーに選ばせ、その間は自動フォールド。フロップ以降は次のアクターはルールで決まるので、従来どおり自動で進める。
- ストリート閉鎖: 全員オールイン時も閉鎖し、「次のストリートへ」で確実に遷移
- ポット: 計算修正と、表示を「合計 / 前ストリートまで / 今ストリート増分」に分割（プリフロは合計のみ）。表示は**英語**で、P5風（skew・極太・赤黒白）を維持する。

---

## サブエージェント割り当て一覧

| ID | 担当範囲 | 依存 |
|----|----------|------|
| A | ポット計算・ストリート閉鎖（all-in対応） | なし |
| B | ポット表示コンポーネント（分割表示） | A |
| C | ヒーロー画面ラベル・カードリールUI（スート左・4色・ランクのみ・縦スクロールなし） | なし |
| D | Who is Open ボトムシート + 対向者（2x/3x/All-in・**プリフロのみ**「次に動いた人」選択・間は自動fold。フロップ以降は従来どおり） | A |
| E | E2E・単体テスト更新 | A,B,C,D |

実行順: **A → B → C → D → E**（C は A と並行可。E は全員の変更を反映後に実行）。

---

## タスクA: ポット計算・ストリート閉鎖（all-in 対応）

**担当**: サブエージェント（PMO は指示のみ）

### 何をやるか
- `isStreetClosed`: 最後のアクションが all-in でも、全アクティブが「同額投入済み or オールイン」ならストリートを閉じるように拡張する。
- ポット計算の不具合があれば修正する（`calculateCurrentPot` / `calculatePotForStreet` の検証と HandContext での使用確認）。

### 完了条件
- 全員オールイン後にストリートが進み、`nextToAct === null` の状態で「次のストリートへ」が表示されたあと、ボード選択または勝者選択へ遷移すること。
- ポットが各アクション後に正しく加算されていること（call/bet/raise/all-in を含む）。

### 参照ファイル
- `src/utils/potUtils.ts`（`isStreetClosed`, `getContributionsThisStreet`, `getMaxContributionThisStreet`, `calculatePotForStreet`, `calculateCurrentPot`）
- `src/contexts/HandContext.tsx`（`addAction` / `addActions` 内での `isStreetClosed` 呼び出しと `pot` 更新）

### 実装メモ（コンテキスト用）
- `isStreetClosed` は現在、最後のアクションが `call` / `fold` でないと `false` を返している（67行目付近）。全アクティブがアクション済みかつ「全員が同額投入 or スタック0」の場合は `true` を返すようにする。必要なら `isStreetClosed` にプレイヤー状態（スタック）を渡す引数を追加する。
- HandContext では `isStreetClosed` 呼び出し時に更新後の `players` を渡す形にし、全員オールイン時にストリートが進むようにする。

### 確認
- 実装後に `npx vitest run` で単体テストを実行する。
- 変更後、MCP ブラウザで記録画面を開き、全員オールイン→次のストリート（または勝者）へ進む流れを確認する。

---

## タスクB: ポット表示（合計・前ストリート・今ストリート増分）

**担当**: サブエージェント

### 何をやるか
- 表示は**英語**で統一する。P5風（skew・極太フォント・赤黒白）を維持する。
- プリフロ: 「Pot: X BB」の1行のみ。
- フロップ以降: 「Total: Z BB」「Before: X BB」「This street: +Y BB」のように**英語**で分割表示する。

### 完了条件
- プリフロで合計ポットのみ（英語）表示されること。
- フロップ/ターン/リバーで、Total / Before / This street が正しく表示されること。
- 文言は英語かつ P5 風スタイル（skew・font-black・mix-blend-mode 等）であること。

### 参照ファイル
- `src/utils/potUtils.ts`（「前ストリート終了時点のポット」「今ストリートの増分」を返すヘルパーを追加または既存関数で算出）
- `src/components/poker/PotDisplay.tsx`（`gameState` から street / actions を受け取り、ストリート別に表示を切り替え）

### 前提
- タスクA でポット計算が正しく行われていること。タスクA の変更ファイル（potUtils, HandContext）を前提として読むこと。

### 確認
- 単体テスト実行。MCP ブラウザで記録画面を開き、プリフロ・フロップでポット表示が意図どおりか確認する。

---

## タスクC: ヒーロー画面ラベル・カードリール（スート左・4色・ランクのみ・縦スクロールなし）

**担当**: サブエージェント

### 何をやるか
1. **ヒーロー画面（HeroSelector）**
   - タイトルを英語にし1行に収める（例: "Select your position"）。`whitespace-nowrap` とレスポンシブフォントで改行させない。
   - 「ハンド（必須）」の「（必須）」を削除。ラベルは「Hand」のみ、または省略可。
   - 「各スートで左右にスクロール → タップで選択」の文言を削除する。
2. **カードリール（SuitBasedCardReel）**
   - レイアウト: **スートを左に固定**し、その右でカードのみ横スクロール。1行 = `[スート固定列]` + `[カード横スクロール]`。
   - カード上には**スートを書かない**。ランクのみ表示（左にスートがあるため）。
   - 4スートを視覚的に区別: ♠ 白、♥ 赤（#D50000）、♦ 金/オレンジ系（#FFC107 等）、♣ スートと区別（例: 薄灰 #B0BEC5 やシアン系）。P5 の赤黒白を崩しすぎない範囲で、4種類はっきり分かるようにする。
   - **縦スクロールなし**でカード全体が見えるようにする（4行を固定高さで収める、または 2x2 グリッドなど）。

### 完了条件
- 記録開始後、ポジション選択画面のタイトルが英語1行で表示されること。
- 「必須」およびスクロール説明の文言が表示されていないこと。
- スートが左固定で、カードはランクのみ・横スクロールのみで、4色が分かり、縦スクロールせずに全カードが見えること。

### 参照ファイル
- `src/components/poker/HeroSelector.tsx`
- `src/components/poker/SuitBasedCardReel.tsx`
- `src/components/poker/BoardSelector.tsx`（同リールを使っている場合は同じレイアウト・色・ランクのみに揃える）

### 確認
- 実装後、MCP ブラウザで `/record` を開き、ヒーロー選択〜カード選択まで表示と操作を確認する。

---

## タスクD: Who is Open ボトムシート + 対向者（2x/3x/All-in・**プリフロのみ**「次に動いた人」・間は自動fold）

**担当**: サブエージェント

### 何をやるか
1. **Who is Open**
   - ポジションをタップしたら、**画面遷移せず**、下からせり上がるボトムシートでアクション（Bet 2x, 3x, All-in）を表示する。
   - 背面は Who is Open のグリッドのまま、**半透明オーバーレイ**（例: `bg-black/50`）で少し透けて見えるようにする。
   - アニメーション: Framer Motion で `y: '100%'` → `y: 0` のスライドアップ。
2. **対向者（Opponents）— プリフロップのみ**
   - 「次に動いたポジション」を選んだあと、Call に加え **Raise 2x**・**Raise 3x**・**All-in** を表示する（スタックに応じて出し分け）。
   - **プリフロップでは毎回**「次に動いたポジション」をユーザーに選ばせる。選んだポジションより**前**（アクション順）にいるプレイヤーは**自動でフォールド**として記録する。例: UTG オープン → ユーザーが BTN を選択 → MP, CO を自動フォールド → BTN のアクション（Call / 2x / 3x / All-in）を表示。
3. **フロップ以降**
   - 次のアクターはルールで一意に決まるため、**従来どおり**「次に動いた人」を毎回ユーザーに選ばせない。`getNextToAct` で決まった1人にポジション/アクションを表示（または自動でアクション画面へ進める）する。現状のフロップ以降のフローを維持する。

### 完了条件
- Who is Open でポジション選択後、ボトムシートで 2x/3x/All-in が選べ、背面が透けて見えること。
- **プリフロップ**の対向者で Call / Raise 2x / Raise 3x / All-in が選べ、アクション後に必ず「次に動いたポジション」選択になり、その間のポジションが自動フォールドされること。
- **フロップ以降**は、次のアクターが自動で決まり、その1人分のアクションのみ選ばせる現行フローが維持されていること。
- ストリートが閉じたあと「次のストリートへ」から正しく遷移すること（タスクA の all-in 対応と整合していること）。

### 参照ファイル
- `src/app/record/page.tsx`（`preflopWhoOpen`, `preflopOpponents`, `handlePreflopWhoOpen`, `handlePreflopOpponentsConfirm`, `handleActionSelect`, ステップ遷移）
- `src/utils/bettingUtils.ts`（`getPreflopBetSizes` 等で 2x/3x/All-in を用意）

### 前提
- タスクA の `isStreetClosed` 修正とストリート進行が入っていること。コンテキストは `potUtils.ts` と `HandContext.tsx` の変更内容を把握したうえで record の遷移を触ること。

### 確認
- 単体・E2E 実行。MCP ブラウザで Who is Open → ボトムシート → **プリフロ**対向者「次に動いた人」→ Call/2x/3x/All-in → 自動フォールド〜フロップへ。フロップ以降は「次に動いた人」選択なしで1人ずつアクションする流れになっていることを確認する。

---

## タスクE: E2E・単体テスト更新

**担当**: サブエージェント

### 何をやるか
- 英語タイトル・「必須」削除・Who is Open ボトムシート・**プリフロのみ**対向者（Call/2x/3x/All-in・「次に動いた人」選択）・フロップ以降は従来フロー・「次のストリートへ」遷移（all-in 含む）・ポット表示（英語・P5風）に合わせて E2E を更新する。
- 全員オールイン→次ストリート（または勝者）へ進むシナリオを 1 本追加または既存でカバーする。
- ポット計算や `isStreetClosed`（all-in）の単体テストを追加・修正する。

### 完了条件
- `npx vitest run` および `npx playwright test` が通ること。
- 上記フローが E2E で少なくとも1シナリオで検証されていること。

### 参照ファイル
- `tests/e2e/record-flow.spec.ts`
- `tests/*.test.ts`（potUtils / HandContext 関連）

### 前提
- タスク A〜D の変更がすべて入った状態でテストを書く。未マージの変更がある場合は、そのブランチ/変更を前提にテストを書く。

### 確認
- CI 相当で vitest と playwright を実行し、すべてパスすることを確認する。

---

## 変更ファイル一覧（サマリ）

| 領域 | ファイル |
|------|----------|
| ポット・ストリート閉鎖 | potUtils.ts, HandContext.tsx |
| ポット表示 | PotDisplay.tsx |
| ヒーロー・カードリール | HeroSelector.tsx, SuitBasedCardReel.tsx, BoardSelector.tsx |
| Who is Open・対向者 | record/page.tsx, bettingUtils.ts（UI用） |
| テスト | record-flow.spec.ts, tests/*.test.ts |

---

## コンテキスト維持のための共有情報

- **.cursorrules**: ペルソナ5風・THルール・最小タップ・6MAX ポジション順は変更しない。
- **データ構造**: poker1 と同じ方針（`Hand`, `GameState`, `ActionRecord` 等）を維持する。
- **PMO_SUBAGENT.md**: サブエージェントは実装後に MCP ブラウザで画面確認を行う。完了報告では「変更ファイル・やったこと・残課題」を短く記載する。
- サブエージェント完了ごとに、PMO は本ドキュメントの「前提」に「タスクX の変更: ファイルY の〜」を追記し、次のタスクのコンテキストとして渡す。
